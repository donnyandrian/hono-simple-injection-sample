<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Prototype Pollution Demo</title>
		<style>
			body {
				font-family: monospace;
				background-color: #2c3e50;
				color: #ecf0f1;
				padding: 20px;
			}
			.container {
				max-width: 900px;
				margin: 0 auto;
				display: grid;
				grid-template-columns: 1fr 1fr;
				gap: 20px;
			}
			.box {
				background: #34495e;
				padding: 20px;
				border-radius: 8px;
				box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
			}
			h2 {
				margin-top: 0;
				border-bottom: 2px solid #e67e22;
				padding-bottom: 10px;
			}
			textarea {
				width: 100%;
				height: 150px;
				background: #2c3e50;
				color: #fff;
				border: 1px solid #7f8c8d;
				padding: 10px;
				font-family: monospace;
			}
			button {
				padding: 10px 15px;
				cursor: pointer;
				border: none;
				font-weight: bold;
				margin-top: 10px;
				width: 100%;
			}
			.btn-vuln {
				background: #c0392b;
				color: white;
			}
			.btn-safe {
				background: #27ae60;
				color: white;
			}
			.btn-check {
				background: #f39c12;
				color: #2c3e50;
			}
			.btn-reset {
				background: #95a5a6;
				color: #2c3e50;
				margin-top: 20px;
			}
			#status-box {
				grid-column: 1 / -1;
				text-align: center;
				font-size: 1.2em;
				border: 2px dashed #7f8c8d;
			}
			.danger {
				color: #e74c3c;
				font-weight: bold;
			}
			.safe {
				color: #2ecc71;
				font-weight: bold;
			}
		</style>
	</head>
	<body>
		<h1 style="text-align: center">JSON Injection (Prototype Pollution)</h1>

		<div id="status-box" class="box">
			CURRENT STATUS: <span id="adminStatus">Checking...</span>
		</div>

		<div class="container" style="margin-top: 20px">
			<!-- Left: Attack Panel -->
			<div class="box">
				<h2>1. User Configuration</h2>
				<p>Update your UI preferences (JSON format).</p>
				<textarea id="jsonInput">
{
    "theme": "dark",
    "showSidebar": false
}</textarea
				>
				<button class="btn-vuln" onclick="sendJson('update-settings')">
					üî¥ Update (Vulnerable Merge)
				</button>
				<button class="btn-safe" onclick="sendJson('update-settings-safe')">
					üü¢ Update (Safe Merge)
				</button>
			</div>

			<!-- Right: Info Panel -->
			<div class="box">
				<h2>2. Verification</h2>
				<p>Check if the system thinks you are an Admin.</p>
				<button class="btn-check" onclick="checkAdmin()">üîç Check Admin Status</button>

				<hr style="border-color: #555; margin-top: 20px" />
				<p>The system creates a fresh object for every check:</p>
				<code>const user = {};</code>
				<p>If pollution succeeds, <code>user.isAdmin</code> becomes true automatically.</p>
				<button class="btn-reset" onclick="resetSystem()">‚ôªÔ∏è Reset System</button>
			</div>
		</div>

		<script>
			// Initial Check
			checkAdmin();

			async function sendJson(endpoint) {
				const input = document.getElementById("jsonInput").value;
				try {
					// Validate JSON syntax locally first
					const body = JSON.parse(input);

					const res = await fetch(`http://localhost:3003/${endpoint}`, {
						method: "POST",
						headers: { "Content-Type": "application/json" },
						body: JSON.stringify(body),
					});
					const data = await res.json();
					alert(
						res.ok ? "Update Success: " + JSON.stringify(data) : "Error: " + data.error
					);

					// Auto check admin after update
					checkAdmin();
				} catch (e) {
					alert("Invalid JSON Syntax: " + e.message);
				}
			}

			async function checkAdmin() {
				const res = await fetch("http://localhost:3003/check-admin");
				const data = await res.json();
				const el = document.getElementById("adminStatus");

				if (data.isAdmin) {
					el.innerHTML = `<span class="danger">‚ö†Ô∏è ADMIN ACCESS GRANTED (${data.message})</span>`;
					document.getElementById("status-box").style.borderColor = "#e74c3c";
				} else {
					el.innerHTML = `<span class="safe">User (Guest) - System Secure</span>`;
					document.getElementById("status-box").style.borderColor = "#2ecc71";
				}
			}

			async function resetSystem() {
				await fetch("http://localhost:3003/reset", { method: "POST" });
				document.getElementById("jsonInput").value =
					'{\n    "theme": "dark",\n    "showSidebar": false\n}';
				checkAdmin();
			}
		</script>
	</body>
</html>
